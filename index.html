<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Lager App</title>

<style>
body {
  margin: 0;
  background: #000;
  color: white;
  font-family: Arial, sans-serif;
}

/* OBERER BEREICH */
#topbar {
  position: fixed;
  inset: 0 0 auto 0;
  background: #000;
  border-bottom: 2px solid #3aa9ff;
  padding: 10px;
  z-index: 1000;
}

.counterBox {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.counterBox div {
  background: #111;
  padding: 10px;
  border-radius: 8px;
  width: 24%;
  text-align: center;
  border: 1px solid #3aa9ff;
}

#controls {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

#controls button, #controls input {
  background: #111;
  color: white;
  border: 1px solid #3aa9ff;
  border-radius: 8px;
  padding: 10px;
}

#controls input {
  flex: 1;
}

/* TABELLE */
#tableContainer {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

table th, table td {
  border-bottom: 1px solid #444;
  padding: 10px;
  text-align: left;
}

/* POPUP */
.popup-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.popup {
  background: #111;
  border: 2px solid #3aa9ff;
  border-radius: 12px;
  padding: 20px;
  width: 90%;
  max-width: 380px;
}

.popup input, .popup textarea {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  background: #000;
  border: 1px solid #3aa9ff;
  color: white;
  border-radius: 8px;
}

.popup button {
  background: #111;
  border: 1px solid #3aa9ff;
  color: white;
  padding: 10px;
  border-radius: 8px;
  width: 48%;
  margin-top: 15px;
}

.popupButtons {
  display: flex;
  gap: 10px;
  justify-content: space-between;
}
</style>
</head>

<body>

<!-- OBERER BEREICH -->
<div id="topbar">
  <div class="counterBox">
    <div>Artikel: <span id="countItems">0</span></div>
    <div>Menge: <span id="countQty">0</span></div>
    <div>Wert aktuell: <span id="valueNow">0</span>€</div>
    <div>Wert gesamt: <span id="valueTotal">0</span>€</div>
  </div>

  <div id="controls">
    <input id="search" placeholder="Suchen..." oninput="searchTable()">
    <button onclick="openPopup()">Artikel anlegen</button>
    <button onclick="backup()">Sichern</button>
    <button onclick="restore()">Laden</button>
    <button onclick="exportPDF()">PDF</button>
  </div>
</div>

<!-- TABELLE -->
<div id="tableContainer">
  <table id="itemTable">
    <thead>
      <tr>
        <th>Nr</th>
        <th>Name</th>
        <th>Menge</th>
        <th>Wert</th>
        <th>Einzel</th>
        <th>Gekauft wo</th>
        <th>Gekauft wann</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- POPUP ARTIKEL -->
<div class="popup-bg" id="popup-bg">
  <div class="popup">
    <h3>Artikel anlegen</h3>

    <input id="p-nr" placeholder="Artikelnummer (optional)">
    <input id="p-name" placeholder="Name">
    <input id="p-date" type="date">
    <input id="p-where" placeholder="Wo gekauft?">
    <input id="p-price" type="number" placeholder="Preis">
    <input id="p-qty" type="number" placeholder="Menge">
    <textarea id="p-note" placeholder="Notiz"></textarea>
    <input id="p-img" type="file" multiple>

    <div class="popupButtons">
      <button onclick="saveItem()">Speichern</button>
      <button onclick="closePopup()">Abbrechen</button>
    </div>
  </div>
</div>

<script>
// -------------------------------------
//        DYNAMISCHE HÖHENANPASSUNG
// -------------------------------------
function adjustTablePosition() {
  const h = document.getElementById("topbar").offsetHeight;
  document.getElementById("tableContainer")
      .style.setProperty("--topbar-height", h + "px");
}
window.addEventListener("resize", adjustTablePosition);
document.addEventListener("DOMContentLoaded", adjustTablePosition);

// -------------------------------------
//             DATABASE SETUP
// -------------------------------------
let db;
let req = indexedDB.open("INVENTAR_DB", 1);

req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("artikel", { keyPath: "nr" });
};

req.onsuccess = e => {
  db = e.target.result;
  loadTable();
};

req.onerror = e => alert("DB Fehler: " + e.target.error);

// -------------------------------------
//             POPUP
// -------------------------------------
function openPopup() {
  document.getElementById("popup-bg").style.display = "flex";
}

function closePopup() {
  document.getElementById("popup-bg").style.display = "none";
}

// -------------------------------------
//             ARTIKEL SPEICHERN
// -------------------------------------
function saveItem() {
  if (!db) {
    alert("DB noch nicht bereit!");
    return;
  }

  let nrField = document.getElementById("p-nr").value.trim();
  let finalNr = nrField;

  // AUTOMATISCHE ARTIKELNUMMER
  if (!finalNr) {
    const tx = db.transaction("artikel", "readonly");
    const store = tx.objectStore("artikel");
    let req = store.getAll();

    req.onsuccess = () => {
      let items = req.result;
      let max = 0;
      items.forEach(it => {
        let num = parseInt(it.nr.split("-")[0]);
        if (num > max) max = num;
      });
      finalNr = String(max + 1).padStart(3, "0") + "-2025";
      saveWithNr(finalNr);
    };
  } else {
    saveWithNr(finalNr);
  }
}

function saveWithNr(nr) {
  let name = document.getElementById("p-name").value.trim();
  let date = document.getElementById("p-date").value;
  let where = document.getElementById("p-where").value.trim();
  let price = parseFloat(document.getElementById("p-price").value) || 0;
  let qty = parseInt(document.getElementById("p-qty").value) || 0;
  let note = document.getElementById("p-note").value;
  let images = [];

  let tx = db.transaction("artikel", "readwrite");
  let store = tx.objectStore("artikel");

  store.put({ nr, name, date, where, price, qty, note, images });

  tx.oncomplete = () => {
    closePopup();
    loadTable();
  };

  tx.onerror = e => alert("Speicherfehler: " + e.target.error);
}

// -------------------------------------
//             TABELLE LADEN
// -------------------------------------
function loadTable() {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const tx = db.transaction("artikel", "readonly");
  const store = tx.objectStore("artikel");
  let req = store.getAll();

  req.onsuccess = () => {
    req.result.forEach(item => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.nr}</td>
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>${(item.qty * item.price).toFixed(2)}</td>
        <td>${item.price}</td>
        <td>${item.where}</td>
        <td>${item.date}</td>
        <td><button onclick="deleteItem('${item.nr}')">Löschen</button></td>
      `;
      tbody.appendChild(tr);
    });
  };
}

function deleteItem(nr) {
  const tx = db.transaction("artikel", "readwrite");
  tx.objectStore("artikel").delete(nr);
  tx.oncomplete = loadTable;
}

</script>
</body>
</html>
