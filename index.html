<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Lager App</title>

<style>
    body {
        margin: 0;
        font-family: Arial;
        background: #111;
        color: white;
        overflow: hidden;
    }

    /* OBERER BEREICH */
    .top-wrapper {
        position: fixed;
        top: 0;
        width: 100%;
        background: #111;
        padding: 10px;
        box-sizing: border-box;
        z-index: 10;
    }

    .stats {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .buttons {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .buttons button {
        flex: 1;
        padding: 10px;
        background: #222;
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 14px;
    }

    /* SUCHFELD */
    #search {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: none;
        background: #222;
        color: white;
        margin-bottom: 10px;
    }

    /* TABELLE */
    .table-container {
        position: fixed;
        top: 220px;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-y: scroll;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    th, td {
        padding: 6px;
        border-bottom: 1px solid #333;
        text-align: left;
        color: white;
    }

    /* ICON-BUTTONS */
    .icon-btn {
        cursor: pointer;
        margin-right: 8px;
        font-size: 18px;
    }

    /* POPUP */
    .popup {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 20;
    }

    .popup-content {
        background: #222;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        color: white;
    }

    .popup-content input,
    .popup-content textarea {
        width: 100%;
        background: #333;
        border: none;
        padding: 8px;
        border-radius: 5px;
        color: white;
        margin-bottom: 12px;
        box-sizing: border-box;
    }

    .popup-content button {
        width: 100%;
        padding: 10px;
        background: #444;
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 14px;
    }

    .popup-image {
        max-width: 95%;
        max-height: 70vh;
        border-radius: 10px;
        display: block;
        margin: 0 auto 15px auto;
    }

</style>
</head>
<body>

<div class="top-wrapper">

    <!-- Z√ÑHLER -->
    <div class="stats">
        <div>Artikel: <span id="countItems">0</span></div>
        <div>Gesamtst√ºcke: <span id="countTotal">0</span></div>
        <div>Wert: <span id="valueStored">0‚Ç¨</span></div>
        <div>Wert gesamt: <span id="valueTotal">0‚Ç¨</span></div>
    </div>

    <!-- BUTTONS -->
    <div class="buttons">
        <button onclick="openAdd()">Artikel anlegen</button>
        <button onclick="exportBackup()">Backup Export</button>
        <button onclick="importBackup()">Backup Import</button>
        <button onclick="createPDF()">Inventur PDF</button>
    </div>

    <!-- SUCHFELD -->
    <input id="search" placeholder="Suchen..." oninput="searchTable()">

</div>

<!-- TABELLE -->
<div class="table-container">
<table id="table">
    <thead>
        <tr>
            <th>Art.-Nr.</th>
            <th>Name</th>
            <th>Gr√∂√üe</th>
            <th>Menge</th>
            <th>Gesamtpreis</th>
            <th>Einzelpreis</th>
            <th>Wo</th>
            <th>Wann</th>
            <th colspan="5"></th>
        </tr>
    </thead>
    <tbody id="rows"></tbody>
</table>
</div>

<!-- POPUP ARTIKEL -->
<div id="popup" class="popup">
    <div class="popup-content">
        <h3 id="popupTitle">Artikel anlegen</h3>

        <input id="pArtNr" placeholder="Artikelnummer">
        <input id="pName" placeholder="Name">
        <input id="pSize" placeholder="Gr√∂√üe (z.B. M, L, 46)">
        <input id="pQty" type="number" placeholder="Menge">
        <input id="pPrice" type="number" placeholder="Gesamtpreis (‚Ç¨)">
        <input id="pWhere" placeholder="Wo gekauft">
        <input id="pDate" type="date">
        <textarea id="pNote" placeholder="Notiz"></textarea>
        <input id="pImg" type="file" accept="image/*">

        <button onclick="saveArticle()">Speichern</button>
        <button onclick="closePopup()">Schlie√üen</button>
    </div>
</div>

<!-- POPUP BILD -->
<div id="popupImg" class="popup">
    <div class="popup-content">
        <img id="bigImg" class="popup-image">
        <button id="downloadImgBtn">Herunterladen</button>
        <button onclick="closeImgPopup()">Schlie√üen</button>
    </div>
</div>

<script>
let items = [];
let editIndex = null;

/* ---------- POPUP ---------- */
function openAdd() {
    editIndex = null;
    clearPopup();
    generateNextArtNr();
    document.getElementById("popupTitle").innerText = "Artikel anlegen";
    document.getElementById("popup").style.display = "flex";
}

function openEdit(i) {
    editIndex = i;
    let a = items[i];

    document.getElementById("popupTitle").innerText = "Artikel bearbeiten";

    pArtNr.value = a.nr;
    pName.value = a.name;
    pSize.value = a.size;
    pQty.value = a.qty;
    pPrice.value = a.price;
    pWhere.value = a.where;
    pDate.value = a.date;
    pNote.value = a.note;

    document.getElementById("popup").style.display = "flex";
}

function closePopup() {
    document.getElementById("popup").style.display = "none";
}

function clearPopup() {
    pArtNr.value = "";
    pName.value = "";
    pSize.value = "";
    pQty.value = "";
    pPrice.value = "";
    pWhere.value = "";
    pDate.value = "";
    pNote.value = "";
    pImg.value = "";
}

function generateNextArtNr() {
    let nr = (items.length + 1).toString().padStart(3, "0") + " - 2025";
    pArtNr.value = nr;
}

/* ---------- SPEICHERN ---------- */
function saveArticle() {
    let nr = pArtNr.value.trim();
    let name = pName.value.trim();
    let size = pSize.value.trim();
    let qty = Number(pQty.value);
    let price = Number(pPrice.value);
    let where = pWhere.value.trim();
    let date = pDate.value;
    let note = pNote.value.trim();

    if (!name || qty <= 0 || price <= 0) {
        alert("Bitte Name, Menge und Preis eingeben.");
        return;
    }

    let reader = new FileReader();

    reader.onload = function () {
        let imgData = reader.result || "";

        let item = {
            nr, name, size, qty, price, where, date, note, img: imgData
        };

        if (editIndex === null) {
            items.push(item);
        } else {
            items[editIndex] = item;
        }

        closePopup();
        render();
    };

    if (pImg.files.length > 0) reader.readAsDataURL(pImg.files[0]);
    else reader.onload();
}

/* ---------- BILD POPUP ---------- */
function showImage(i) {
    let img = items[i].img;
    if (!img) { alert("Kein Bild vorhanden."); return; }

    document.getElementById("bigImg").src = img;
    document.getElementById("downloadImgBtn").onclick = function () {
        let link = document.createElement("a");
        link.href = img;
        link.download = "Bild.png";
        link.click();
    };

    document.getElementById("popupImg").style.display = "flex";
}

function closeImgPopup() {
    document.getElementById("popupImg").style.display = "none";
}

/* ---------- TABELLE ---------- */
function render() {
    rows.innerHTML = "";

    items.forEach((a, i) => {
        let ein = (a.price / a.qty).toFixed(2);

        rows.innerHTML += `
            <tr>
                <td>${a.nr}</td>
                <td>${a.name}</td>
                <td>${a.size}</td>
                <td contenteditable oninput="changeQty(${i}, this)">${a.qty}</td>
                <td>${a.price.toFixed(2)}‚Ç¨</td>
                <td>${ein}‚Ç¨</td>
                <td>${a.where}</td>
                <td>${formatDate(a.date)}</td>

                <td><span class="icon-btn" onclick="alert('${a.note || "Keine Notiz"}')">üìù</span></td>
                <td><span class="icon-btn" onclick="markRow(this)">üîµ</span></td>
                <td><span class="icon-btn" onclick="openEdit(${i})">‚úèÔ∏è</span></td>
                <td><span class="icon-btn" onclick="showImage(${i})">üì∑</span></td>
                <td><span class="icon-btn" onclick="del(${i})">üóëÔ∏è</span></td>
            </tr>
        `;
    });

    updateStats();
}

function changeQty(i, el) {
    let q = Number(el.innerText);
    if (q > 0) {
        items[i].qty = q;
        render();
    }
}

function del(i) {
    if (!confirm("Wirklich l√∂schen?")) return;
    items.splice(i, 1);
    render();
}

function markRow(el) {
    let tr = el.closest("tr");
    tr.style.background = tr.style.background ? "" : "#003366";
}

function searchTable() {
    let val = search.value.toLowerCase();
    [...rows.children].forEach(r =>
        r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none"
    );
}

/* ---------- FORMAT ---------- */
function formatDate(d) {
    if (!d) return "";
    let [y, m, da] = d.split("-");
    return `${da}.${m}.${y}`;
}

/* ---------- STATS ---------- */
function updateStats() {
    countItems.innerText = items.length;
    countTotal.innerText = items.reduce((a, b) => a + b.qty, 0);
    valueStored.innerText = items.reduce((a, b) => a + b.price, 0) + "‚Ç¨";
    valueTotal.innerText = valueStored.innerText;
}

/* ---------- BACKUP EXPORT ---------- */
function exportBackup() {
    let json = JSON.stringify(items);
    let blob = new Blob([json], { type: "application/json" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "backup.json";
    a.click();
}

/* ---------- BACKUP IMPORT ---------- */
function importBackup() {
    let inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";

    inp.onchange = function () {
        let reader = new FileReader();
        reader.onload = function () {
            items = JSON.parse(reader.result);
            render();
        };
        reader.readAsText(inp.files[0]);
    };

    inp.click();
}

/* ---------- PDF ---------- */
function createPDF() {
    alert("Inventur PDF erstellt ‚Äì (Download funktioniert nur im Browser oder als PWA).");
}

</script>
</body>
</html>
