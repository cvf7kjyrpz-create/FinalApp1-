<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Lager App</title>

<style>

/* ============================================= */
/* GLOBAL DARK MODE */
/* ============================================= */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  overflow: hidden;
}

/* ============================================= */
/* FIXIERTER OBERER BEREICH (wie Version davor) */
/* ============================================= */
#topbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #111;
  padding: 15px;
  border-bottom: 2px solid #3aa9ff;
  z-index: 1000;
}

#counters {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-bottom: 10px;
}

.counter-box {
  background: #1a1a1a;
  padding: 8px 12px;
  border-radius: 5px;
  border: 1px solid #3aa9ff;
}

#controls {
  display: flex;
  gap: 8px;
}

#controls button {
  background: #1a1a1a;
  color: white;
  border: 1px solid #3aa9ff;
  padding: 8px 10px;
  border-radius: 5px;
}

#search {
  background: #1a1a1a;
  border: 1px solid #3aa9ff;
  padding: 8px;
  color: white;
  border-radius: 5px;
  flex: 1;
}

/* ============================================= */
/* TABELLE — NICHT UNTER HEADER SCROLLEN */
/* ============================================= */
#tableContainer {
  position: absolute;
  top: var(--topbar-height);
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  overflow-x: auto;
  background: #000;
}

table {
  width: 100%;
  border-collapse: collapse;
  color: white;
}

thead {
  position: sticky;
  top: 0;
  background: #111;
}

td, th {
  padding: 8px;
  border-bottom: 1px solid #333;
}

/* ============================================= */
/* POPUP */
/* ============================================= */
#popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #111;
  padding: 20px;
  width: 80%;
  max-width: 380px;
  border: 2px solid #3aa9ff;
  border-radius: 8px;
  z-index: 2000;
  display: none;
}

.popup-row {
  display: flex;
  flex-direction: column;
  margin-bottom: 12px;
}

.popup-row input {
  padding: 8px;
  background: #1a1a1a;
  color: white;
  border: 1px solid #3aa9ff;
  border-radius: 5px;
}

#popup button {
  width: 100%;
  background: #3aa9ff;
  border: none;
  padding: 10px;
  color: #000;
  border-radius: 5px;
  margin-top: 10px;
}

</style>

</head>
<body>

<!-- ============================================= -->
<!-- OBERER BEREICH (ALTE GUTE VERSION) -->
<!-- ============================================= -->

<div id="topbar">

  <div id="counters">
    <div class="counter-box">Artikel: <span id="countArticles">0</span></div>
    <div class="counter-box">Menge: <span id="countQty">0</span></div>
    <div class="counter-box">Wert: <span id="countValue">0 €</span></div>
    <div class="counter-box">Wert gesamt: <span id="countValueTotal">0 €</span></div>
  </div>

  <div id="controls">
    <input type="text" id="search" placeholder="Suchen…" oninput="searchTable()">
    <button onclick="openPopup()">Artikel anlegen</button>
    <button onclick="saveBackup()">Sichern</button>
    <button onclick="loadBackup()">Laden</button>
    <button onclick="exportPDF()">PDF</button>
  </div>

</div>

<!-- ============================================= -->
<!-- TABELLE -->
<!-- ============================================= -->

<div id="tableContainer">
  <table id="itemTable">
    <thead>
      <tr>
        <th>Nr</th>
        <th>Name</th>
        <th>Menge</th>
        <th>Wert</th>
        <th>Wert/Stk</th>
        <th>Wo gekauft</th>
        <th>Wann gekauft</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
  </table>
</div>

<!-- ============================================= -->
<!-- POPUP -->
<!-- ============================================= -->

<div id="popup">
  <div class="popup-row">
    <label>Artikelnummer</label>
    <input id="p_nr">
  </div>

  <div class="popup-row">
    <label>Name</label>
    <input id="p_name">
  </div>

  <div class="popup-row">
    <label>Menge</label>
    <input id="p_qty" type="number">
  </div>

  <div class="popup-row">
    <label>Preis / Stück</label>
    <input id="p_price" type="number" step="0.01">
  </div>

  <div class="popup-row">
    <label>Wo gekauft</label>
    <input id="p_where">
  </div>

  <div class="popup-row">
    <label>Wann gekauft</label>
    <input id="p_date" type="date">
  </div>

  <button onclick="saveItem()">Speichern</button>
</div>

<script>

/* ============================================= */
/* DYNAMISCHE POSITION FÜR TABELLE */
/* ============================================= */
function adjustTablePosition() {
  const topbar = document.getElementById("topbar");
  const tableContainer = document.getElementById("tableContainer");
  tableContainer.style.setProperty("--topbar-height", topbar.offsetHeight + "px");
}

document.addEventListener("DOMContentLoaded", adjustTablePosition);
window.addEventListener("resize", adjustTablePosition);

/* ============================================= */
/* DATENSPEICHERUNG */
/* ============================================= */

let items = JSON.parse(localStorage.getItem("lagerItems") || "[]");

function saveItem() {
  try {
    const nr = document.getElementById("p_nr").value.trim();
    const name = document.getElementById("p_name").value.trim();
    const qty = Number(document.getElementById("p_qty").value);
    const price = Number(document.getElementById("p_price").value);
    const where = document.getElementById("p_where").value.trim();
    const date = document.getElementById("p_date").value;

    if (!nr || !name) return;

    items.push({ nr, name, qty, price, where, date });
    localStorage.setItem("lagerItems", JSON.stringify(items));

    renderTable();
    closePopup();
  } catch (e) {
    alert("Fehler: " + e);
  }
}

function renderTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  let totalQty = 0;
  let totalValue = 0;

  items.forEach(item => {
    totalQty += item.qty;
    totalValue += item.qty * item.price;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.nr}</td>
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td>${(item.qty * item.price).toFixed(2)} €</td>
      <td>${item.price.toFixed(2)} €</td>
      <td>${item.where}</td>
      <td>${item.date}</td>
      <td><button onclick="deleteItem('${item.nr}')">Löschen</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("countArticles").innerText = items.length;
  document.getElementById("countQty").innerText = totalQty;
  document.getElementById("countValue").innerText = totalValue.toFixed(2) + " €";
  document.getElementById("countValueTotal").innerText = totalValue.toFixed(2) + " €";
}

function deleteItem(nr) {
  items = items.filter(item => item.nr !== nr);
  localStorage.setItem("lagerItems", JSON.stringify(items));
  renderTable();
}

/* ============================================= */
/* POPUP */
/* ============================================= */

function openPopup() {
  document.getElementById("popup").style.display = "block";
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

/* ============================================= */
/* BACKUP */
/* ============================================= */
function saveBackup() {
  const blob = new Blob([JSON.stringify(items)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lager_backup.json";
  a.click();
}

function loadBackup() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      items = JSON.parse(reader.result);
      localStorage.setItem("lagerItems", JSON.stringify(items));
      renderTable();
    };
    reader.readAsText(file);
  };
  input.click();
}

renderTable();

</script>

</body>
</html>
